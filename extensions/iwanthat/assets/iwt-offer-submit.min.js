window.iwtHandleSubmit=async function(e){e.preventDefault();const t=iwtGetEl("iwt-submit-offer");if(t&&!t.disabled)if(iwtValidateForm()){t.disabled=!0;try{console.log(" Form is valid. Fetching cart...");const e=await window.iwtFetchCart();if(!e||!e.items||0===e.items.length)return console.error(" Cart is empty or failed to load."),void alert("Your cart is empty. Please add items before making an offer.");console.log("Cart fetched successfully:",e),await iwtSubmitOfferToAPI(e)}catch(e){console.error(" Error during submission:",e)}finally{t.disabled=!1}}else console.log(" Form validation failed. Submission prevented.")},window.iwtSubmitOfferToAPI=async function(e){try{console.log("Preparing offer submission...");const t=window.location.origin.replace(/^https?:\/\//,"");console.log(" Store URL: ",t);const o=(()=>{const t=[...new Set(e.items.map((e=>e.properties?.template||"regular")))];return t.length>1?"mixed":"iwtclearance"===t[0]?"clearance only":"regular only"})();console.log(" Cart Composition:",o);const i={storeUrl:t,consumerName:iwtGetEl("iwt-name").value,consumerEmail:iwtGetEl("iwt-email").value,consumerMobile:iwtGetEl("iwt-mobile").value,consumerPostalCode:iwtGetEl("iwt-postal").value,currency:e.currency,offerPrice:parseFloat(iwtGetEl("iwt-offer-price").value).toFixed(2),tosChecked:iwtGetEl("iwt-tos-checkbox").checked,tosCheckedDate:(new Date).toISOString(),cartToken:e.token,cartCreateDate:window.iwtCartCreated||(new Date).toISOString(),cartUpdateDate:window.iwtCartUpdated||(new Date).toISOString(),offerCreateDate:(new Date).toISOString(),cartComposition:o,items:e.items.map((t=>({productID:t.product_id,productName:t.product_title,productURL:t.url,variantID:t.variant_id,sku:t.sku,quantity:t.quantity,price:t.presentment_price,lineTotal:t.quantity*t.presentment_price,cartToken:e.token,template:t.properties?.template||"regular"}))),cartItems:new Set(e.items.map((e=>e.sku))).size,cartUnits:e.items.reduce(((e,t)=>e+t.quantity),0),cartTotalPrice:(e.total_price/100).toFixed(2)};console.log("Submitting offer: ",i);const r=await fetch("https://app.iwantthat.io/version-test/api/1.1/wf/cart-offer-evaluation/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!r.ok)throw new Error(` API Response Error: ${r.status}`);const n=await r.json();console.log("Offer Response Received:",n.response),n?.response?"function"==typeof window.iwtDisplayResponse?(console.log(" Calling iwtDisplayResponse..."),await window.iwtDisplayResponse(n.response),console.log(" Display Response executed.")):(console.error(" iwtDisplayResponse is missing. Ensure iwt-offer-response.js is loaded."),alert("Offer submitted, but response handling failed.")):(console.warn(" Unexpected response format. Please try again."),alert("Unexpected response. Please try again later."))}catch(e){console.error(" Error when submitting offer:",e),alert("Error when submitting offer. Please try again later.")}},document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("iwt-submit-offer");e&&e.addEventListener("click",window.iwtHandleSubmit)}));