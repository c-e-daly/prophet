let cart,srcTemplate,sGURL,cartTemplateMix,cartCreated=null,cartUpdated=null;const getEl=t=>document.getElementById(t);function resetModalData(){getEl("iwt-table").innerHTML="";const t=getEl("iwt-quantity");t&&(t.value=1);const e=getEl("iwt-subtotal");e&&(e.value=0)}function closeModal(){const t=getEl("iwt-modal");t&&(t.style.display="none"),resetModalData()}document.addEventListener("DOMContentLoaded",(async()=>{const t=getEl("iwt-modal"),e=getEl("iwt-modal-btn");t?(t.style.display="none",document.body.appendChild(t),e&&e.addEventListener("click",(t=>{t.stopPropagation(),closeModal()})),t.addEventListener("click",(e=>{e.target===t&&closeModal()}))):console.error("Modal container not found."),cart=await fetchCart(),strtEventListen()}));const openOfferModal=async function({template:t,dVID:e,sUrl:r}){let o;if(srcTemplate=t,sGURL=r,resetModalData(),"cart"===t||"checkout"===t)cart=await fetchCart(),o=cart.token,rendTable(cart);else if("product"===t||"iwantthat"===t||"iwtclearance"===t){let r=e;const a=gVIDURL();a?r=a:console.log("Variant ID not found in URL");const n=gQTY();console.log("Quantity:",n);try{await addToCart({ID:r,quantity:n,template:t})}catch(t){console.error(`Error adding product ${r} to the cart`,t)}cart=await fetchCart(),o=cart.token,rendTable(cart)}syncTableCart();getEl("iwt-modal").style.display="block"};function syncTableCart(){const t=getEl("iwt-qty");if(t){const e=cart.items.reduce(((t,e)=>t+e.quantity),0);t.value=e}const e=getEl("iwt-subtotal");e&&(e.value=cart.total_price)}const gVIDURL=()=>new URLSearchParams(window.location.search).get("variant"),gCDT=()=>(new Date).toISOString();function gQTY(){const t=document.querySelector(".quantity__input");return t?parseInt(t.value,10):(console.log("Quantity input not found, returning default value of 1"),1)}function updateCartDates(t){const e=gCDT();t&&!cartCreateDate&&(cartCreateDate=e),cartUpdateDate=e}const addToCart=async function({ID:t,quantity:e,template:r}){try{const o=cart.items.find((e=>e.variant_id===t&&e.properties?.template===r));if(o){const r=o.quantity+e,a=await fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:o.key,quantity:r})});if(!a.ok)throw new Error(`Network response was not ok, status: ${a.status}`);const n=await a.json();cartUpdated=gCDT();const i=n.items.find((e=>e.variant_id===t));return i&&i.quantity<r?{success:!0,availQty:i.quantity,backOrdQty:r-i.quantity,cart:n}:{success:!0,availQty:r,backOrdQty:0,cart:n}}{const o={items:[{id:t,quantity:e,properties:{template:r}}]},a=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!a.ok)throw new Error(`Network response was not ok, status: ${a.status}`);const n=await a.json();cartCreated||(cartCreated=gCDT()),cartUpdated=gCDT();const i=n.items.find((e=>e.id==t));return i&&i.quantity<e?{success:!0,availQty:i.quantity,backOrdQty:e-i.quantity,cart:n}:{success:!0,availQty:e,backOrdQty:0,cart:n}}}catch(t){return console.error("Error adding to cart:",t),{success:!1,error:t}}},uIQH=async(t,e)=>{if(cart.items.find((e=>e.key===t)))try{await uIQ(t,e),await uRendCart()}catch(t){console.error("Error updating item quantity:",t)}else console.error("Item not found for quantity update")},uRendCart=async()=>{cart=await fetchCart(),cart?rendTable(cart):console.error("Failed to fetch updated cart data")},fetchCart=async function(){try{const t=await fetch("/cart.js");if(!t.ok)throw new Error("Network response was not ok");return await t.json()}catch(t){return console.error("Error fetching cart:",t),null}},uIQ=async(t,e)=>{try{const r=cart.items.find((e=>e.key===t));if(!r)throw new Error("Item not found in the cart");const o=await addToCart({ID:r.variant_id,quantity:e,template:r.properties.template});if(!o.success)throw new Error(o.error||"Failed to update quantity");const a=document.querySelector(`input[data-line-item-key="${t}"]`);if(o.backOrdQty>0)a&&(a.style.borderColor="orange",a.title=`Only ${o.availQty} in stock. ${o.backOrdQty} will be back-ordered.`),showModalError(`Only ${o.availQty} items are available. ${o.backOrdQty} items will be back-ordered.`);else{a&&(a.style.borderColor="",a.title=""),clearModalError();const r=await fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,quantity:e})});if(!r.ok)throw new Error(`Network response was not ok, status: ${r.status}`);const o=await r.json();rendTable(o)}}catch(e){console.error("Error updating item quantity:",e);const r=document.querySelector(`input[data-line-item-key="${t}"]`);r&&(r.style.borderColor="red",r.title="Error updating quantity. Please try again."),showModalError("Unable to update quantity. Please try again.")}},clearModalError=()=>{const t=getEl("iwt-modal-error");t&&(t.style.display="none",t.innerText="")};document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll(".iwt-input-number").forEach((t=>{t.addEventListener("input",(async e=>{const r=t.getAttribute("data-line-item-key"),o=parseInt(e.target.value);await uIQH(r,o)}))}))}));const clearInptError=t=>{t.style.borderColor="",t.title="";const e=getEl("iwt-modal-error");e&&(e.style.display="none")};document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll(".iwt-input-number").forEach((t=>{t.addEventListener("input",(()=>clearInptError(t)))}))}));const removeItem=async t=>{try{const e=await fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,quantity:0})});if(!e.ok)throw new Error(`Network response was not ok, status: ${e.status}`);const r=await e.json();rendTable(r)}catch(t){console.error("Error removing item from cart:",t)}},rendTable=function(t,e=null){if(!t)return void console.error("Cart is null");if(!t.items)return void console.error("Cart items property is missing");let r='<table><thead class="table-header"><tr>';const o=["product_title","quantity","price"],a={product_title:"Product Name",quantity:"Units",price:"Price",line_price:"Line Price"};o.forEach((t=>{r+=`<th>${a[t]}</th>`})),r+=`<th>${a.line_price}</th></tr></thead><tbody>`;let n=0;t.items.forEach(((t,e)=>{r+=`<tr style="background-color: ${e%2==0?"#fff":"#f2f2f2"};">`,o.forEach((e=>{if("product_title"===e)r+=`\n                    <td>\n                        <div>${t.product_title}</div>\n                        <div style="font-size: 0.8em; color: #666;">SKU: ${t.sku||"N/A"}</div>\n                    </td>`;else if("quantity"===e)r+=`<td><input type="number" class="iwt-input-number" value="${t[e]}" min="1" onchange="uIQ('${t.key}', this.value)" data-line-item-key="${t.key}"></td>`;else{const o="price"===e?formatPrice(t[e]):t[e];r+=`<td>${o||""}</td>`}}));const a=t.price*t.quantity;n+=a,r+=`<td>${formatPrice(a)}</td>`,r+=`\n          <td style="background-color: white;">\n            <button class="iwt-remove-item" onclick="removeItem('${t.key}')" title="Remove item" style="color: red; font-size: 16px; border: none; background: none;">\n              &cross;\n            </button>\n          </td>\n        `,r+="</tr>"})),r+=`\n      </tbody>\n      <tfoot>\n        <tr style="background-color: #0442b4; color: #fff;">\n          <td colspan="${o.length}">Subtotal</td>\n          <td id="iwt-cart-total">${formatPrice(n)}</td>\n        </tr>\n    `,null!==e&&(r+=`\n        <tr>\n          <td colspan="${o.length}">Accepted Offer Price</td>\n          <td>${formatPrice(e)}</td>\n        </tr>\n      `),r+="</tfoot></table>";const i=getEl("iwt-table");i?i.innerHTML=r:console.error("Element with ID iwt-cart-table not found")},formatPrice=t=>`$${(t/100).toFixed(2)}`,checkTemplateMix=t=>new Set(t.map((t=>t.properties?.template||"regular"))).size>1;function strtEventListen(){const t=getEl("submit-btn"),e=getEl("iwt-form");t&&e&&(t.removeEventListener("click",handleSubmit),t.addEventListener("click",handleSubmit))}async function handleSubmit(t){t.preventDefault();const e=getEl("submit-btn");if(!e.disabled)if(vForm()){e.disabled=!0;try{await submitOfferToAPI(t)}catch(t){console.error("Error during submission:",t)}finally{e.disabled=!1}}else console.log("Form is invalid. Submission prevented.")}function vForm(){let t=!0;const e=getEl("iwt-name"),r=getEl("iwt-email"),o=getEl("iwt-mobile"),a=getEl("iwt-postal"),n=getEl("iwt-offer-price"),i=getEl("iwt-tos-checkbox"),s=getEl("iwt-cart-total");let l=0;return s&&s.textContent?(l=parseFloat(s.textContent.replace(/[^\d.-]/g,"")),isNaN(l)&&(console.error("Cart total is not a valid number"),l=0)):(console.error("Cart total element not found or has invalid content"),l=0),clearError(e),clearError(r),clearError(o),clearError(a),clearError(n),getEl("iwt-tos-error").style.display="none",e.value.trim()||(showError(e,"Please fill in your first and last name"),t=!1),r.value.trim()?vEmail(r.value)||(showError(r,"Please enter a valid email"),t=!1):(showError(r,"Please fill in your email"),t=!1),o.value.trim()?vPhone(o.value)||(showError(o,"Please enter a valid phone number"),t=!1):(showError(o,"Please fill in your mobile number"),t=!1),a.value.trim()||(showError(a,"Please fill in your postal code"),t=!1),!n.value.trim()||parseFloat(n.value)<=0?(showError(n,"Offer price must be greater than zero"),t=!1):parseFloat(n.value)>l&&(showError(n,"Offer price cannot exceed the cart total"),t=!1),i.checked||(getEl("iwt-tos-error").style.display="block",t=!1),t}const vEmail=t=>/^[\w.+-]+@[a-zA-Z\d-]+\.[a-zA-Z]{2,}$/.test(t),vPhone=t=>/^\d{10}$/.test(t);function showError(t,e){t.style.borderColor="red",t.style.borderWidth="2px";const r=t.parentElement.querySelector(".custom-tooltip");r&&r.remove();const o=document.createElement("div");o.className="iwt-custom-tooltip",o.innerText=e,t.parentElement.appendChild(o);const a=t.getBoundingClientRect();o.style.left=`${a.left+window.scrollX}px`,o.style.top=`${a.bottom+window.scrollY+5}px`,setTimeout((()=>{o.classList.add("fade-out"),setTimeout((()=>o.remove()),1800)}),5e3)}function clearError(t){t.style.borderColor="",t.style.borderWidth="";const e=t.parentElement.querySelector(".custom-tooltip");e&&e.remove()}async function submitOfferToAPI(t){if(t.preventDefault(),!vForm())return;const e=getEl("submit-btn");try{e.disabled=!0,cart=await fetchCart();const t=t=>{const e=[...new Set(t.map((t=>t.properties?.template||"regular")))];return e.length>1?"mixed":"iwtclearance"===e[0]?"clearance only":"regular only"},r=parseFloat(getEl("iwt-offer-price").value).toFixed(2),o=(cart.total_price/100).toFixed(2),a={storeUrl:sGURL.replace(/^https?:\/\//,""),consumerName:getEl("iwt-name").value,consumerEmail:getEl("iwt-email").value,consumerMobile:getEl("iwt-mobile").value,consumerPostalCode:getEl("iwt-postal").value,currency:cart.currency,offerPrice:r,tosChecked:getEl("iwt-tos-checkbox").checked,tosCheckedDate:(new Date).toISOString(),cartToken:cart.token,cartCreateDate:cartCreated,cartUpdateDate:cartUpdated,offerCreateDate:(new Date).toISOString(),cartComposition:t(cart.items),items:cart.items.map((t=>({productID:t.product_id,productName:t.product_title,productURL:t.url,variantID:t.variant_id,sku:t.sku,quantity:t.quantity,price:t.presentment_price,cartToken:cart.token,template:t.properties?.template}))),cartItems:new Set(cart.items.map((t=>t.sku))).size,cartUnits:cart.items.reduce(((t,e)=>t+e.quantity),0),cartTotalPrice:o};console.log("Submitting offer: ",a);const n=await fetch("https://app.iwantthat.io/version-test/api/1.1/wf/cart-offer-evaluation/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!n.ok)throw new Error(`Error when submitting offer: ${n.status}`);const i=await n.json();console.log("Parsed response:",i),i?.response?function(t){let e=t.offerStatus,r=t.offerAmount,o=t.storeBrand,a=t.firstName,n=t.checkoutUrl,i=t.expiryMinutes,s=t.discountCode,l=t.cartPrice;const c=getEl("iwt-offer"),d=getEl("iwt-response"),u=getEl("iwt-message"),p=getEl("woohoo-image"),y=getEl("whoops-image"),f=getEl("pending-image");c.classList.add("fade-out"),setTimeout((()=>{c.style.display="none",d.style.display="flex",d.classList.add("fade-in");let t="";o=o||"our store!";const m=`\n                    <p class="iwtP">Hey ${a}, you just made a Great Deal using I Want That!  \n                    Your offer of ${r} has been <strong>accepted</strong>. \n                    Your deal will expire in ${i} minutes. Click on the button below and go claim it. Congratulations!</p>\n                    <p class="iwtP">Thanks for shopping ${o}</p>\n                    </br>\n                    <p class="iwtP">p.s. Your coupon code is:</p>\n                    <div>\n                        <input type="text" value="${s}" id="iwtCode" readonly class="floating-input">\n                        <button onclick="copyCode()" class="click-to-copy">Click to Copy</button>\n                    </div>\n                    <p id="copyMessage" style="display:none; color: #80bf9b; margin-top: 10px;">Coupon code copied to clipboard!</p>\n                `,w=`\n                    <p class="iwtP">Hey ${a}, thanks for the offer but unfortunately we cannot make ${r} off ${l} work. \n                    If you would like to submit a new offer, just select the button below. Thanks for shopping ${o}!</p>\n                    <button class="iwt-retry-offer-button" onclick="retry()">Make Another Offer</button>\n                `,g=`\n                    <p class="iwtP">Hey ${a}, thanks for your offer of ${r} for your cart.  \n                    We are currently reviewing the offer and our customer service team will get back to you shortly. Have a great day and thanks for shopping ${o}!</p>\n                `;if("Auto Accepted"===e){p.style.display="block",t=m;const e=getEl("iwt-checkout"),r=getEl("iwt-checkout-button");e.style.display&&"none"!==e.style.display||(r.href=n,e.style.display="flex")}else"Auto Declined"===e?(y.style.display="block",t=w):"Pending Review"===e?(f.style.display="block",t=g):t=`<p class="iwtP">Unexpected status: ${e}. Please try again later.</p>`;u.innerHTML=t}),500)}(i.response):alert("Unexpected response. Please try again later.")}catch(t){console.error("Error when submitting offer:",t),alert("Error when submitting offer. Please try again later.")}finally{e.disabled=!1}window.copyCode=function(){const t=getEl("iwtCode");t.select(),t.setSelectionRange(0,99999),navigator.clipboard.writeText(t.value).then((()=>{getEl("copyMessage").style.display="block",setTimeout((()=>{getEl("copyMessage").style.display="none"}),2e3)}))},window.retry=function(){getEl("iwt-response").style.display="none";const t=getEl("iwt-offer");t.classList.remove("fade-out"),t.style.display="flex",t.classList.add("fade-in"),console.log("Retry button clicked");const e=getEl("iwt-offer-price");e&&(e.value="")},document.addEventListener("DOMContentLoaded",strtEventListen)}document.addEventListener("DOMContentLoaded",strtEventListen);